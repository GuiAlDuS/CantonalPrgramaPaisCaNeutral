---
title: "Visualizando los datos cantonales del piloto del Programa País Carbono Neutral"
description: | 
  Tutorial de análisis de datos de la Dirección de Cambio Climático de Costa Rica como parte del fellow de la Iniciativa Latinoamericana para los Datos Abiertos (ILDA)
author: 
- name: "Guillermo Durán Sanabria"
date: "12/13/2018"
output:
  radix::radix_article:
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

En este tutorial se trabajará con las tablas resultado del piloto del **Programa País Carbono Neutralidad categoría cantonal**, suministrados por la Dirección de Cambio Climático (DCC) del Ministerio de Ambiente y Energía (MINAE).

La tabla contiene datos del inventario de emisiones de gases de efecto invernadero realizado en los cantones de **Belén**, **San José**, **Golfito**, **La Unión**, **Desamparados** y **Monteverde**. Más información sobre el proyecto que generó estos datos puede accederse en el sitio web de la DCC.

Los paquetes que se utilizarán en el análisis son:

```{r message=FALSE, warning=FALSE}
library(tidyverse)
```


## Lectura de la tabla de datos
La tabla con los datos de los cantones pueden accederse [acá](https://raw.githubusercontent.com/GuiAlDuS/CantonalProgramaPaisCaNeutral/master/TablaGeneralCantones.csv).

```{r}
tablaGeneralIni <- read_csv("TablaGeneralCantones.csv")
```

La tabla  cuenta con siete columnas:

- *aNo*: el año del reporte.
- *Canton*: cantón que reporta.
- *Sector*: sector general generador de emisiones.
- *Específico*: sector específico generador de emisiones.
- *Alcance 1 (ton CO2 eq)*: Emisiones directas de gases de efecto invernadero (GEI).
- *Alcance 2 (ton CO2 eq)*: Emisiones indirectas de GEI asociadas a la electricidad.
- *Alcance 3 (ton CO2 eq)*: Otras emisiones indirectas.

En caso de querer profundizar más sobre el significado de los distintos alcances, se recomienda consultar el [**Protocolo de gases de efecto invernadero. Estándar corporativo de contabilidad y reporte**](http://c40-production-images.s3.amazonaws.com/other_uploads/images/1016_GPC_Full_MASTER_v6_ESXM-02-02_FINALpdf.original.pdf?1486373653).

Corrección de nombres de columnas y tipos de datos en las columnas:

```{r}
tablaGeneralIni <- tablaGeneralIni %>% 
  mutate(
    Esp = `Específico`,
    Alc1 = as.numeric(`Alcance 1 (ton CO2 eq)`),
    Alc2 = as.numeric(`Alcance 2 (ton CO2 eq)`),
    Alc3 = as.numeric(`Alcance 3 (ton CO2 eq)`),
    Canton = case_when(Canton == "Belen" ~ "Belén",
                       Canton == "LaUnion" ~ "La Unión",
                       Canton == "SanJose" ~ "San José",
                       TRUE ~ as.character(Canton))
  )
```

### Resumen de variables:
Sectores generales y número de sectores específicos por cada sector general:

```{r}
tablaGeneralIni %>% group_by(Sector, Esp) %>% summarise() %>% group_by(Sector) %>% summarise(n())
```

Total de sectores específicos:

```{r}
tablaGeneralIni %>% 
  group_by(Esp) %>% 
  summarise(
    sumAlc1 = sum(Alc1, na.rm = T),
    sumAlc2 = sum(Alc2, na.rm = T),
    sumAlc3 = sum(Alc3, na.rm = T),
    sumTot = sumAlc1 + sumAlc2) %>% 
  filter(sumTot != 0)
```
Notese que existen varios sectores específicos con cero emisiones tanto en los tres alcances. De un total de 22 sectores específicos pasamos a 14 con emisiones.

Para la claridad de los gráficos, eliminamos esos sectores específicos sin emisiones en ninguno de los dos alcances.

```{r}
tablaGeneral <- tablaGeneralIni %>%
  left_join(tablaGeneralIni %>% 
              group_by(Esp) %>% 
              summarise(
                sumAlc1 = sum(Alc1, na.rm = T),
                sumAlc2 = sum(Alc2, na.rm = T),
                sumAlc3 = sum(Alc3, na.rm = T),
                sumTot = sumAlc1 + sumAlc2) %>% 
              filter(sumTot != 0), 
            by = "Esp") %>% 
  filter(sumTot != 0) %>% 
  select(-(4:7), -(12:14))
  
```


## Gráficos
Los gráficos se generarán con la libraría Altair, utilizando la interface de R para Python **reticulate**. Altair es una excelente librería para crear gráficos interactivos. La guía para la instalación de Altair en R la pueden encontrar acá.

El mapa con ubicación de los cantones se hará utilizando datos geográficos de la Infraestructura de Datos Espaciales de Costa Rica (SNIT):

```{r message=FALSE, warning=FALSE}
library(sf)
library(gdalUtils)
library(rgdal)

dsn_prov <- "WFS:http://geos.snitcr.go.cr/be/IGN_5/wfs?"
ogrListLayers(dsn_prov) #lista de capas en ese WFS
```

Descargamos el límite cantonal, cortamos a la extensión de Costa Rica continental y transformamos al sistema de coordenadas WGS84:

```{r}
library(rmapshaper)
cantones_geo <- st_read(dsn_prov, "IGN_5:limitecantonal_5k") %>% 
  st_crop(. , c(xmin = 270000, xmax = 680000, ymax = 1260000, ymin = 880000)) %>% 
  st_transform(., 4326)

cantones_geo <- ms_simplify(ms_simplify(cantones_geo)) #simplificación de polígonos para reducir tamaño del objeto
  
```

Ya que Altair no trabaja con objetos de clase *sf*, debemos convertir los cantones a geoJSON/topoJSON:

```{r}
library(geojsonio)

cantonesJSON <- geojson_json(cantones_geo)

cantonesJSONEstudio <- 
  geojson_json(cantones_geo %>% 
                 select(nom_cant, SHAPE) %>% 
                 right_join(tablaGeneral %>% 
                              group_by(Canton) %>% 
                              summarise(Alc1 = round(sum(Alc1, na.rm = T), 0),
                                        Alc2 = round(sum(Alc2, na.rm = T), 0),
                                        Alc3 = round(sum(Alc3, na.rm = T), 0)), 
                            by = c("nom_cant" = "Canton"))
  )

```

Generación de mapa de los cantones con datos:

```{r}
library(altair)

cantones <- alt$Data(values = cantonesJSON) #específicamos que el objeto es JSON
cantonesEstudio <- alt$Data(values = cantonesJSONEstudio,
                            format = alt$DataFormat(property='features', type = 'json')
)

mapaBase <- 
  alt$Chart(cantones,
            title = "Cantones participantes")$
  mark_geoshape(
    fill = "lightgray",
    stroke = "white",
    strokeWidth = 1
  )$
  encode()$
  properties(width = 300, height = 300)

mapaCantones <- 
  alt$Chart(cantonesEstudio)$
  mark_geoshape(
  )$
  encode(
    alt$Color("properties.nom_cant:N",
              title = "Cantones",
              scale=alt$Scale(scheme="paired")
    ),
    tooltip = list(
      alt$Tooltip(field = "properties.nom_cant",
                  type = "nominal",
                  title = "Cantón"),
      alt$Tooltip(field = "properties.Alc1",
                  type = "quantitative",
                  title = "Alcance 1 (ton. de CO2)",
                  format = ".5s"),
      alt$Tooltip(field = "properties.Alc2",
                  type = "quantitative",
                  title = "Alcance 2 (ton. de CO2)",
                  format = ".3s"),
            alt$Tooltip(field = "properties.Alc3",
                  type = "quantitative",
                  title = "Alcance 3 (ton. de CO2)",
                  format = ".3s")
      )
  )

mapa <- (mapaBase + mapaCantones)$
  configure_axis(grid = FALSE)$
  configure_view(strokeWidth = 0)

mapa
```

### Visualizaciones por cantón:

Total de emisiones de los tres alcances por cantón:

```{r}
totalesCanton <- tablaGeneral %>% 
  gather(key = tipoAlc, value = valorAlc, -(1:4), -8) %>% 
  group_by(Canton, tipoAlc) %>% 
  summarise(totalAlc = sum(valorAlc, na.rm = T)) %>% 
  mutate(tipoAlc = case_when(tipoAlc == "Alc1" ~ "Alcance 1",
                             tipoAlc == "Alc2" ~ "Alcance 2",
                             tipoAlc == "Alc3" ~ "Alcance 3"))

graficoAlcs <- 
  alt$Chart(totalesCanton)$
  mark_bar()$
  encode(
    x = alt$X(
      "totalAlc:Q",
      axis = alt$Axis(title = "Equivalente a toneladas de CO2")
    ),
    y = alt$Y(
      "Canton",
      axis = alt$Axis(title = "")
    ),
    color = alt$Color(
      "tipoAlc",
      legend = alt$Legend(title = "Tipo de alcance"),
      scale=alt$Scale(scheme="Category10")
    ),
    tooltip = list(
      alt$Tooltip(field = "tipoAlc",
                  type = "nominal",
                  title = "Tipo"),
      alt$Tooltip(field = "totalAlc",
                  type = "quantitative",
                  title = "Total de emisiones",
                  format = ".5s")
    )
  )

graficoAlcs  
```



Total de emisiones de *alcance 1* por cantón en valores reales (toneladas) y normalizados:

```{r}
graficoTotAlc1 <- 
  alt$Chart(tablaGeneral)$
  mark_bar()$
  encode(
    y = alt$Y(
      "Canton",
      axis = alt$Axis(title = "")
    ),
    x = alt$X(
      "Alc1:Q",
      axis = alt$Axis(title = "Emisiones del Alcance 1 equivalentes a toneladas de CO2")
    ),
    color = "Sector",
    tooltip = list(
      alt$Tooltip(field = "Sector",
                  type = "nominal",
                  title = "Sector general"),
      alt$Tooltip(field = "Esp",
                  type = "nominal",
                  title = "Sector específico"),
      alt$Tooltip(field = "Alc1",
                  type = "quantitative",
                  title = "Alcance 1 (equiv. a ton. de CO2)",
                  format = ".5s")
    )
  )$configure_legend(labelLimit= 0)

graficoTotAlc1
```

Para observar mejor la proporción que aporte cada sector al total del cantón hacemos un gráfico donde igualamos las dimensiones de las barras y en el eje de las x mostramos el porcentaje de aporte de cada sector.

```{r}
graficoNor <- 
  alt$Chart(tablaGeneral)$
  mark_bar()$
  encode(
    x = alt$X(
      "Alc1:Q", 
      stack="normalize",
      axis = alt$Axis(title = "Porcentaje del total del Alcance 1",
                      format = ".0%")
      ),
    y = alt$Y(
      "Canton",
      axis = alt$Axis(title = "")
      ),
    color = "Sector",
        tooltip = list(
      alt$Tooltip(field = "Sector",
                  type = "nominal",
                  title = "Sector general"),
      alt$Tooltip(field = "Esp",
                  type = "nominal",
                  title = "Sector específico"),
      alt$Tooltip(field = "Alc1",
                  type = "quantitative",
                  title = "Alcance 1 (ton. de CO2)",
                  format = ".5s")
      )
  )$configure_legend(labelLimit= 0)

 graficoNor
```

Dadas las opciones de interactividad que brinda **Altair**  haremos un gráfico interactivo donde al hacer click a la barra del cantón nos muestre los valores de emisión por sector específico.

El código sería el siguiente:

```{r}
seleccion <- alt$selection(type = "single", 
                           encodings = list("y"))

graficoTot <- 
  alt$Chart(tablaGeneral)$
  mark_bar()$
  encode(
    y = alt$Y(
      "Canton",
      axis = alt$Axis(title = "")
    ),
    x = alt$X(
      "Alc1:Q", 
      axis = alt$Axis(title = "Emisiones dequivalentes a toneladas de CO2")
    ),
    color = alt$condition(seleccion, "Sector", alt$value("lightgray"))
  )$
  properties(selection = seleccion)

graficoEsp <- 
  alt$Chart(tablaGeneral,
            title = "Sectores específicos")$
  mark_bar()$
  encode(
    y = alt$Y(
      "Esp",
      axis = alt$Axis(title = "")
    ),
    x = alt$X(
      "Alc1:Q",
      axis = alt$Axis(title = "Emisiones dequivalentes a toneladas de CO2")
    ),
    color = alt$Color(
      "Sector:N",
      title = "Sectores generales")
  )$
  transform_filter(seleccion$ref())

grafCompuesto <- (graficoTot & graficoEsp)$
  properties(
    title = "Emisiones de Alcance 1 por sectores según cantón"
  )$
  configure_axis(labelLimit=10000)$
  configure_legend(labelLimit= 0)

grafCompuesto
```


### Visualizaciones por sectores
Ahora los gráficos de emisiones de *alcance 1* por sectores generales y específicos, mostrando los cantones con colores:

```{r}
graficoEsp <- 
  alt$Chart(tablaGeneral,
            title = "Sectores específicos")$
  mark_bar()$
  encode(
    y = alt$Y(
      "Esp",
      axis = alt$Axis(title = "")
    ),
    x = alt$X(
      "Alc1:Q",
      axis = alt$Axis(title = "Valores del Alcance 1")
    ),
    color = alt$Color("Canton", scale=alt$Scale(scheme="dark2")),
    tooltip = "Esp"
  )

graficoSec <- 
  alt$Chart(tablaGeneral,
            title = "Sectores generales")$
  mark_bar()$
  encode(
    y = alt$Y(
      "Sector",
      axis = alt$Axis(title = "")
      ),
    x = alt$X(
      "Alc1:Q",
      axis = alt$Axis(title = "")
    ),
    color = "Canton"
  )

grafico <- (graficoSec & graficoEsp)$configure_axis(labelLimit=10000)

grafico
```

Cálculo de emisiones condicionadas por población:

```{r}

```


Cálculo de emisiones condicionadas según las áreas de cada cantón:

```{r}

```